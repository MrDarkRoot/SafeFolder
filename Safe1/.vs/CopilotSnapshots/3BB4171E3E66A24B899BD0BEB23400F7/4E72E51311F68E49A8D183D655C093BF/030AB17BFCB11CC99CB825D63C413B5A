using Safe1.Models;
using Safe1.Services;
using Safe1.Views;
using System;
using System.Collections.ObjectModel;
using System.Threading.Tasks;
using System.Windows.Input;
using System.Linq;
using System.Windows;

namespace Safe1.ViewModels
{
    public class MainViewModel : BaseViewModel
    {
        public ObservableCollection<ProtectedFolderModel> ProtectedFolders { get; } = new ObservableCollection<ProtectedFolderModel>();

        public ICommand AddFolderCommand { get; }
        public ICommand HandleFolderActionCommand { get; }
        public ICommand LockApplicationCommand { get; }
        public ICommand OpenSettingsCommand { get; }

        private readonly DatabaseManager _db;
        private readonly SecureAccessService _secureAccess;

        public MainViewModel()
        {
            var dbKey = ConfigurationManager.RetrieveDatabaseKey();
            _db = new DatabaseManager(dbKey ?? string.Empty);
            _db.InitializeDatabase();

            ConfigurationManager.EnsureProtectedFolderTable(_db);

            _secureAccess = SecureAccessService.CreateSecureWorkspace();

            AddFolderCommand = new RelayCommand(async (p) => await ExecuteAddFolder());
            HandleFolderActionCommand = new RelayCommand(async (p) => await ExecuteHandleAction(p));
            LockApplicationCommand = new RelayCommand((p) => ExecuteLockApplication());
            OpenSettingsCommand = new RelayCommand((p) => ExecuteOpenSettings());

            LoadFoldersFromDb();
        }

        private void LoadFoldersFromDb()
        {
            var records = ConfigurationManager.GetProtectedFolderRecords(_db);
            ProtectedFolders.Clear();
            foreach (var r in records)
            {
                ProtectedFolders.Add(r);
            }
        }

        private async Task ExecuteAddFolder()
        {
            var demoPath = System.IO.Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments), "NewProtectedFolder");
            ConfigurationManager.AddProtectedFolder(_db, demoPath);
            LoadFoldersFromDb();
        }

        private void ExecuteLockApplication()
        {
            // Trigger any UI navigation to Login
        }

        private void ExecuteOpenSettings()
        {
            // open settings dialog
        }

        private async Task ExecuteHandleAction(object parameter)
        {
            if (!(parameter is ProtectedFolderModel model)) return;

            if (model.ProtectionMode == ProtectionMode.NORMAL)
            {
                try
                {
                    var newPath = await QuickProtectService.QuickLockAsync(model.FolderPath).ConfigureAwait(false);
                    ConfigurationManager.UpdateFolderPath(_db, model.FolderPath, newPath);
                    ConfigurationManager.UpdateProtectionMode(_db, newPath, "LOCKED");
                    model.FolderPath = newPath;
                    model.ProtectionMode = ProtectionMode.LOCKED;
                }
                catch
                {
                }
            }
            else if (model.ProtectionMode == ProtectionMode.LOCKED)
            {
                try
                {
                    var stw = SecureAccessService.CreateSecureWorkspace();
                    ConfigurationManager.UpdateProtectionMode(_db, model.FolderPath, "NORMAL");
                    model.ProtectionMode = ProtectionMode.NORMAL;
                }
                catch
                {
                }
            }
            else if (model.ProtectionMode == ProtectionMode.ENCRYPTED)
            {
                try
                {
                    // Prompt for master password on UI thread
                    string master = null;
                    Application.Current.Dispatcher.Invoke(() =>
                    {
                        var dlg = new PasswordPromptWindow("Enter master password to decrypt folder:");
                        if (dlg.ShowDialog() == true) master = dlg.EnteredPassword;
                    });

                    if (string.IsNullOrEmpty(master)) return;

                    var progress = new Progress<double>(p => { /* TODO: update UI progress bar */ });
                    await EncryptionService.DecryptFolderAsync(model.FolderPath, master, _db, progress).ConfigureAwait(false);
                    ConfigurationManager.UpdateProtectionMode(_db, model.FolderPath, "NORMAL");
                    model.ProtectionMode = ProtectionMode.NORMAL;
                }
                catch
                {
                }
            }
        }
    }
}
