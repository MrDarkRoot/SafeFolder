using Microsoft.Data.Sqlite;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Safe1.Services
{
    public class DatabaseManager
    {
        private const string DatabaseFileName = "SafeFolder.db";
        private string _databaseKey; // Key giải mã CSDL (đã được giải mã bằng DPAPI)

        public DatabaseManager(string decryptedDbKey)
        {
            _databaseKey = decryptedDbKey;
            // Khởi tạo SQLCipher runtime
            SQLitePCL.Batteries_V2.Init();
        }

        /// <summary>
        /// Tạo chuỗi kết nối SQLCipher.
        /// </summary>
        private string GetConnectionString()
        {
            var connectionString = new SqliteConnectionStringBuilder
            {
                DataSource = DatabaseFileName,
                // Lệnh PRAGMA key sẽ mã hóa/giải mã toàn bộ CSDL.
                Password = _databaseKey
            }.ToString();
            return connectionString;
        }

        /// <summary>
        /// Mở kết nối và đảm bảo CSDL tồn tại và được mở khóa.
        /// </summary>
        public void InitializeDatabase()
        {
            using (var connection = new SqliteConnection(GetConnectionString()))
            {
                connection.Open();
                // Thực hiện câu lệnh PRAGMA key (tự động)

                // Tạo bảng CONFIGURATION nếu chưa tồn tại
                string createTableQuery = @"
                    CREATE TABLE IF NOT EXISTS CONFIGURATION (
                        config_id TEXT PRIMARY KEY,
                        master_hash TEXT NOT NULL,
                        salt TEXT NOT NULL,
                        timeout_mins INTEGER
                    );";

                using (var command = new SqliteCommand(createTableQuery, connection))
                {
                    command.ExecuteNonQuery();
                }
            }
        }

        // Phương thức khác để thực hiện truy vấn SELECT, INSERT, v.v.
        public SqliteConnection GetConnection()
        {
            // Trả về kết nối mở để các DataAccess classes khác sử dụng
            var connection = new SqliteConnection(GetConnectionString());
            connection.Open();
            return connection;
        }

    }
}
